name: Central Wiki Sync Logic

on:
  workflow_call:
    inputs:
      source_repo:
        required: false
        type: string
        default: "infinition/AcidWiki"

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  core-sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Caller Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Ensure Wiki Directory Exists
        run: mkdir -p wiki/docs

      - name: Sync Core Files from Source
        env:
          SOURCE_REPO: ${{ inputs.source_repo }}
        run: |
          # 1. Clone du moteur source
          git clone --depth 1 --branch main https://github.com/$SOURCE_REPO.git temp_source
          
          # 2. Copie des fichiers système (On écrase tout pour être à jour)
          cp -rv temp_source/index.html .
          cp -rv temp_source/wiki/themes wiki/
          cp -rv temp_source/wiki/assets wiki/
          cp -rv temp_source/wiki/manifest.json wiki/
          cp -rv temp_source/wiki/sw.js wiki/
          
          # 3. On remet le config.js "template" vierge pour le modifier proprement
          cp -rv temp_source/wiki/config.js wiki/
          
          rm -rf temp_source

      - name: Dynamic Config Injection
        env:
          REPO_FULL: ${{ github.repository }}
        run: |
          CONFIG_FILE="wiki/config.js"
          JSON_FILE="acidwiki.json"
          
          echo ">>> 1. DÉTECTION DU CONTEXTE"
          # Extraction du nom du repo (ex: Bjorn)
          REPO_NAME=$(echo "$REPO_FULL" | awk -F '/' '{print $2}')
          YEAR=$(date +'%Y')
          
          # Récupération de la dernière version (Release ou Tag)
          # Si rien trouvé, retourne une chaîne vide
          LATEST_TAG=$(gh api repos/$REPO_FULL/releases/latest --jq .tag_name 2>/dev/null || gh api repos/$REPO_FULL/tags --jq '.[0].name' 2>/dev/null || echo "")
          
          echo "Repo: $REPO_NAME"
          echo "Version trouvée: '$LATEST_TAG'"

          echo ">>> 2. LECTURE DE ACIDWIKI.JSON"
          # Valeurs par défaut
          DISCORD=""
          REDDIT=""
          COFFEE="https://buymeacoffee.com/infinition"

          if [ -f "$JSON_FILE" ]; then
            echo "Fichier de config json trouvé."
            # Extraction via JQ. Si la clé manque ou est null, on récupère vide.
            DISCORD=$(jq -r '.social.discord // empty' $JSON_FILE)
            REDDIT=$(jq -r '.social.reddit // empty' $JSON_FILE)
            JSON_COFFEE=$(jq -r '.buymeacoffee // empty' $JSON_FILE)
            if [ -n "$JSON_COFFEE" ]; then COFFEE=$JSON_COFFEE; fi
          else
            echo "Pas de acidwiki.json. Utilisation des défauts."
          fi

          echo ">>> 3. RÉÉCRITURE DE CONFIG.JS"
          
          # --- A. IDENTITÉ PROJET ---
          # Remplace le nom et les sous-titres par le nom du Repo en Majuscules
          sed -i "s|projectName: \".*\"|projectName: \"${REPO_NAME^^}\"|g" $CONFIG_FILE
          sed -i "s|projectSubtitle: \".*\"|projectSubtitle: \"${REPO_NAME^^} WIKI\"|g" $CONFIG_FILE
          sed -i "s|description: \".*\"|description: \"Official Documentation and Wiki for ${REPO_NAME}\"|g" $CONFIG_FILE
          sed -i "s|repo: \".*\"|repo: \"$REPO_FULL\"|g" $CONFIG_FILE
          
          # --- B. VERSIONNING INTELLIGENT ---
          # On force le mode "local" pour avoir le contrôle total de l'affichage
          sed -i "s|type: \"github\"|type: \"local\"|g" $CONFIG_FILE
          
          if [ -n "$LATEST_TAG" ]; then
             # Si version existe : on l'injecte
             sed -i "s|manualVersion: \".*\"|manualVersion: \"$LATEST_TAG\"|g" $CONFIG_FILE
          else
             # Si PAS de version : on met vide (le CSS cachera l'élément)
             sed -i "s|manualVersion: \".*\"|manualVersion: \"\"|g" $CONFIG_FILE
          fi
          # Date du jour pour la config technique
          sed -i "s|manualDate: \".*\"|manualDate: \"$(date +'%Y-%m-%d')\"|g" $CONFIG_FILE

          # --- C. LIENS SOCIAUX ---
          
          # 1. GITHUB (Toujours actif, pointe vers le repo courant)
          sed -i "s|github: \".*\"|github: \"https://github.com/$REPO_FULL\",|g" $CONFIG_FILE
          sed -i "s|githubLabel: \".*\"|githubLabel: \"SOURCE CODE\"|g" $CONFIG_FILE
          
          # 2. BUY ME A COFFEE (Actif)
          sed -i "s|buyMeACoffee: \".*\"|buyMeACoffee: \"$COFFEE\"|g" $CONFIG_FILE
          
          # 3. DISCORD (Dynamique selon JSON)
          if [ -n "$DISCORD" ]; then
            sed -i "s|discord: .*|discord: \"$DISCORD\",|g" $CONFIG_FILE
          else
            sed -i "s|discord: .*|discord: null,|g" $CONFIG_FILE
          fi
          
          # 4. REDDIT (Dynamique selon JSON)
          if [ -n "$REDDIT" ]; then
            sed -i "s|reddit: .*|reddit: \"$REDDIT\",|g" $CONFIG_FILE
          else
            sed -i "s|reddit: .*|reddit: null,|g" $CONFIG_FILE
          fi

          # --- D. NETTOYAGE UI ---
          
          # Footer avec Année et Nom
          sed -i "s|footerText: \".*\"|footerText: \"© $YEAR ${REPO_NAME^^} WIKI - All rights reserved\"|g" $CONFIG_FILE
          
          # Logo Fixe
          sed -i "s|logoPath: \".*\"|logoPath: \"wiki/assets/logo.png\"|g" $CONFIG_FILE
          
          # Désactivation des liens Top/Bottom (Main Site, Portfolio...)
          # On remplace le contenu des tableaux par vide []
          sed -i "s|top: \[.*|top: [],|g" $CONFIG_FILE
          sed -i "s|bottom: \[.*|bottom: []|g" $CONFIG_FILE

      - name: Commit and Push Changes
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add index.html wiki/
          # Commit seulement si changements détectés
          git diff --quiet && git diff --staged --quiet || (git commit -m "chore: update wiki config from acidwiki.json [skip ci]" && git push)