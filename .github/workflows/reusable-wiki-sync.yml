name: Central Wiki Sync Logic

on:
  workflow_call:
    inputs:
      source_repo:
        required: false
        type: string
        default: "infinition/AcidWiki"

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  core-sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Caller Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Ensure Wiki Directory Exists
        run: mkdir -p wiki/docs

      - name: Sync Core Files from Source
        env:
          SOURCE_REPO: ${{ inputs.source_repo }}
        run: |
          # 1. Clone
          git clone --depth 1 --branch main https://github.com/$SOURCE_REPO.git temp_source
          
          # 2. Copy Core
          cp -rv temp_source/index.html .
          cp -rv temp_source/wiki/themes wiki/
          cp -rv temp_source/wiki/assets wiki/
          cp -rv temp_source/wiki/manifest.json wiki/
          cp -rv temp_source/wiki/sw.js wiki/
          
          # 3. Reset Config Template
          cp -rv temp_source/wiki/config.js wiki/
          
          rm -rf temp_source

      - name: Dynamic Config Injection
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO_FULL: ${{ github.repository }}
        run: |
          CONFIG_FILE="wiki/config.js"
          JSON_FILE="acidwiki.json"
          
          # --- 1. DETECTION ---
          REPO_NAME=$(echo "$REPO_FULL" | awk -F '/' '{print $2}')
          LATEST_TAG=$(gh api repos/$REPO_FULL/releases/latest --jq .tag_name 2>/dev/null || gh api repos/$REPO_FULL/tags --jq '.[0].name' 2>/dev/null || echo "")
          YEAR=$(date +'%Y')
          
          echo "Repo detected: $REPO_NAME"

          # --- 2. LECTURE JSON ---
          DISCORD=""
          REDDIT=""
          COFFEE="https://buymeacoffee.com/infinition"

          if [ -f "$JSON_FILE" ]; then
            echo "Loading acidwiki.json..."
            DISCORD=$(jq -r '.social.discord // empty' $JSON_FILE)
            REDDIT=$(jq -r '.social.reddit // empty' $JSON_FILE)
            JSON_COFFEE=$(jq -r '.buymeacoffee // empty' $JSON_FILE)
            if [ -n "$JSON_COFFEE" ]; then COFFEE=$JSON_COFFEE; fi
          fi

          # --- 3. INJECTION (CORRECTIF VIRGULES) ---
          
          # > Identité
          # Pas de virgule ajoutée ici car on remplace entre les guillemets
          sed -i "s|projectName: \".*\"|projectName: \"${REPO_NAME^^}\"|g" $CONFIG_FILE
          sed -i "s|projectSubtitle: \".*\"|projectSubtitle: \"${REPO_NAME^^} WIKI\"|g" $CONFIG_FILE
          sed -i "s|description: \".*\"|description: \"Official Documentation and Wiki for ${REPO_NAME}\"|g" $CONFIG_FILE
          sed -i "s|repo: \".*\"|repo: \"$REPO_FULL\"|g" $CONFIG_FILE
          
          # > Footer
          sed -i "s|footerText: \".*\"|footerText: \"© $YEAR ${REPO_NAME^^} WIKI - All rights reserved\"|g" $CONFIG_FILE
          
          # > Github (CORRECTION ICI : On retire la virgule finale du remplacement)
          sed -i "s|github: \".*\"|github: \"https://github.com/$REPO_FULL\"|g" $CONFIG_FILE
          sed -i "s|githubLabel: \".*\"|githubLabel: \"SOURCE CODE\"|g" $CONFIG_FILE
          
          # > Coffee
          sed -i "s|buyMeACoffee: \".*\"|buyMeACoffee: \"$COFFEE\"|g" $CONFIG_FILE
          
          # > Discord & Reddit
          # Ici on remplace TOUTE la ligne (null ou "url") donc on DOIT garder la virgule car le regex .* mange tout
          if [ -n "$DISCORD" ]; then
            sed -i "s|discord: .*|discord: \"$DISCORD\",|g" $CONFIG_FILE
          else
            sed -i "s|discord: .*|discord: null,|g" $CONFIG_FILE
          fi
          
          if [ -n "$REDDIT" ]; then
            sed -i "s|reddit: .*|reddit: \"$REDDIT\",|g" $CONFIG_FILE
          else
            sed -i "s|reddit: .*|reddit: null,|g" $CONFIG_FILE
          fi
          
          # > Menus
          sed -i "s|top: \[.*|top: [],|g" $CONFIG_FILE
          sed -i "s|bottom: \[.*|bottom: []|g" $CONFIG_FILE

          # > Versioning
          sed -i "s|type: \"github\"|type: \"local\"|g" $CONFIG_FILE
          
          if [ -n "$LATEST_TAG" ]; then
             sed -i "s|manualVersion: \".*\"|manualVersion: \"$LATEST_TAG\"|g" $CONFIG_FILE
          else
             sed -i "s|manualVersion: \".*\"|manualVersion: \"\"|g" $CONFIG_FILE
          fi
          sed -i "s|manualDate: \".*\"|manualDate: \"$(date +'%Y-%m-%d')\"|g" $CONFIG_FILE

      - name: Commit and Push Changes
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add index.html wiki/
          git diff --quiet && git diff --staged --quiet || (git commit -m "chore: update wiki config [skip ci]" && git push)
      
      - name: Auto-Configure GitHub Pages
        env:
          GH_TOKEN: ${{ secrets.GH_PAT_ADMIN || github.token }}
          REPO: ${{ github.repository }}
        run: |
          gh api "repos/$REPO/pages" -X POST -F "source[branch]=main" -F "source[path]=/" --silent || true
          OWNER="${REPO%%/*}"
          REPO_NAME="${REPO#*/}"
          gh api "repos/$REPO" -X PATCH -F "homepage=https://$OWNER.github.io/$REPO_NAME/" --silent || true